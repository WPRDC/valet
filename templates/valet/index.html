{% extends "base.html" %}
{% load static %}
{% block title %}Parking Reports{% endblock %}

{% block stylesheet %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="{% static 'valet/css/skeleton.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'valet/css/normalize.css' %}">
<style>
table {
    width: 50%;
}

th {
    height: 30px;
}
</style>
{% endblock stylesheet %}

{% block javascript %}
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>

    function replace_selector_with_options(selector,options) {
        var $el = $(selector);
        $el.empty(); // remove old options
        $.each(options, function(key,value) {
          $el.append($("<option></option>")
               .attr("value", value).text(key));
               });
    }

    function refresh_field_options() {
        var resource = $("#id_resource").val();

        $.ajax({
        url: 'ajax/get_fields/',
        data: {
          'resource': resource
        },
        dataType: 'json',
        success: function (data) {
            replace_selector_with_options("#id_input_field",data.field_choices)
            replace_selector_with_options("#id_output_field",data.field_choices)
            $("#id_output_field").val($('#id_output_field option').eq(1).val());
            }
        });

    }

    function generate_formulas() {
        var resource = $("#id_resource").val();
        var input_field = $("#id_input_field").val();
        var output_field = $("#id_output_field").val();
        var spreadsheet_column = $("#id_input_column_index").val();


        $.ajax({
        url: 'ajax/get_formulas/',
        data: {
          'resource': resource,
          'input_field': input_field,
          'output_field': output_field,
          'spreadsheet_column': spreadsheet_column
        },
        dataType: 'json',
        success: function (data) {
            $("#excel_formula").val(data.excel_formula)
            }
        });
    }

    function refresh_dates() {
        var quarter = $("#id_quarter").val();

        $.ajax({
        url: 'ajax/get_dates/',
        data: {
          'quarter': quarter
        },
        dataType: 'json',
        success: function (data) {
            $("#start_date").html(data.start_date)
            $("#end_date").html(data.end_date);
            }
        });
    }

    $("#id_quarter").change(function () {
        var quarter = $(this).val();
        var zone = $("#id_zone").val();

        $.ajax({
          url: 'ajax/get_results/',
          data: {
            'zone': zone,
            'quarter': quarter
          },
          dataType: 'json',
          success: function (data) {
              $("#output").html(data.output_table)
          }
      });

    });

    $("#id_zone").change(function () {
        var zone = $(this).val();
        var quarter = $("#id_quarter").val();

        $.ajax({
          url: 'ajax/get_results/',
          data: {
            'zone': zone,
            'quarter': quarter
          },
          dataType: 'json',
          success: function (data) {
              $("#output").html(data.output_table)
          }
      });

    });

    $("#id_quarter").change(refresh_dates);
    $("#id_resource").change(refresh_field_options);

    $("#id_output_field").change(generate_formulas);
    $("#id_output_field").val($('#id_output_field option').eq(1).val());

  </script>
{% endblock %}

{% block content %}
<div class="container">
    <h3>Pittsburgh Parking Reports</h3>
    <br>
    <div class="row">
         <div class="six columns">
             <form method="post">
                {% csrf_token %}
                {{ zone_picker }}
            </form>
        </div>
        <div class="six columns">
            <h5>Zone/lot features:</h5> 
            <b>Rate:</b> ${{ zone_features.rate }}/hour, <b>Space count:</b> {{ zone_features.spaces }}, <b>Lease count:</b> {{ zone_features.leases }} 
            <P>
            <h5>Time range</h5>
            <b>Start date:</b> <span id="start_date">{{ start_date }}</span>, <b>End date:</b> <span id="end_date">{{ end_date }}</span>
        </div>
    </div>
    <P>
    <div class="row">
        <div class="twelve columns">
            <div id="output">
                {% autoescape off %}
                {{output_table}}
                {% endautoescape %}
            </div>
        </div>
    </div>

</div>
{% endblock content %}
{% block footer %}
{% endblock footer %}
