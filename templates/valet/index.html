{% extends "base.html" %}
{% load static %}
{% block title %}Parking Reports{% endblock %}

{% block stylesheet %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
<link rel="stylesheet" type="text/css" href="{% static 'valet/css/skeleton.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'valet/css/normalize.css' %}">
<style>
table {
    width: 70%;
}

th {
    height: 30px;
    text-align: right;
}

td {
    text-align: right;
}
</style>
{% endblock stylesheet %}

{% block javascript %}
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>
  <script type="text/javascript">
    function hide_results(bool) {
        document.getElementById('results').style.display=(bool?'none':'block');
    }

    function reset_month_picker() {
          $('#id_month').val(" ");
          $('#id_year').val(" ");
    }

    function replace_selector_with_options(selector,options) {
        var $el = $(selector);
        $el.empty(); // remove old options
        $.each(options, function(key,value) {
          $el.append($("<option></option>")
               .attr("value", value).text(key));
               });
    }

    function refresh_features() {
        var zone = $("#id_zone").val();
        var month = $("#id_month").val();
        var year = $("#id_year").val();
        var from_date = frompicker.toString('YYYY-MM-DD');
        var to_date = topicker.toString('YYYY-MM-DD');

        if (document.getElementById("date-tab").getAttribute("aria-hidden") == "false") {
            var search_by = "date";
        } else if (document.getElementById("month-tab").getAttribute("aria-hidden") == "false") {
            var search_by = "month";
        } else {
            var search_by = "new mode";
        }

        $.ajax({
        url: 'ajax/get_features/',
        data: {
          'zone': zone,
          'month': month,
          'year': year,
          'search_by': search_by,
          'from_date': from_date,
          'to_date': to_date
        },
        dataType: 'json',
        success: function (data) {
            $("#rate").html(data.rate)
            $("#spaces").html(data.spaces);
            $("#leases").html(data.leases);
            }
        });
    }

    function refresh_dates() {
        var month = $("#id_month").val();
        var year = $("#id_year").val();
        var from_date = frompicker.toString('YYYY-MM-DD');
        var to_date = topicker.toString('YYYY-MM-DD');

        if (document.getElementById("date-tab").getAttribute("aria-hidden") == "false") {
            var search_by = "date";
        } else if (document.getElementById("month-tab").getAttribute("aria-hidden") == "false") {
            var search_by = "month";
        } else {
            var search_by = "new mode";
        }

        $.ajax({
        url: 'ajax/get_dates/',
        data: {
          'month': month,
          'year': year,
          'search_by': search_by,
          'from_date': from_date,
          'to_date': to_date,
        },
        dataType: 'json',
        success: function (data) {
            $("#selected_time_range").html(data.display_time_range)
            $("#start_dt").html(data.start_dt)
            $("#end_dt").html(data.end_dt);
            }
        });
    }

    function regenerate_output() {
        var zone = $("#id_zone").val();
        var month = $("#id_month").val();
        var year = $("#id_year").val();
        var search_by = $("id_search_by").val();

        var from_date = frompicker.toString('YYYY-MM-DD');
        var to_date = topicker.toString('YYYY-MM-DD');

        if (document.getElementById("date-tab").getAttribute("aria-hidden") == "false") {
            var search_by = "date";
        } else if (document.getElementById("month-tab").getAttribute("aria-hidden") == "false") {
            var search_by = "month";
        } else {
            var search_by = "new mode";
        }

        hide_results(true);
        $.ajax({
            url: 'ajax/get_results/',
        data: {
            'zone': zone,
            'month': month,
            'year': year,
            'search_by': search_by,
            'from_date': from_date,
            'to_date': to_date
        },
        dataType: 'json',
        success: function (data) {
            hide_results(false)
            $("#output").html(data.output_table)
            $("#output_zone").html(data.display_zone)
            // update chart
            myChart.data.labels = data.chart_ranges;
            myChart.config.data.datasets[0].data = data.transactions_chart_data;
            myChart.config.data.datasets[1].data = data.payments_chart_data;
            myChart.update();
            }
        });
    }

    $("#id_month").change(refresh_dates);
    $("#id_year").change(refresh_dates);
    $("#id_month").change(refresh_features);
    $("#id_year").change(refresh_features);
    $("#id_zone").change(refresh_features);
    $("#id_zone").change(regenerate_output);
    $("#id_month").change(regenerate_output);
    $("#id_year").change(regenerate_output);

    $("#date-picker-link").on("click", reset_month_picker);
    hide_results(false);
    </script>
    <script>
        $( function() {
            $( "#tabs" ).tabs();
        } );
    </script>
<script>
var ctx = document.getElementById("myChart").getContext('2d');
var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {% autoescape off %}{{ chart_ranges }}{% endautoescape %},
        datasets: [{
            label: 'Transactions',
            data: {{ transactions_chart_data }},
            yAxisID: 'y-axis-1',
            backgroundColor:
                'rgba(54, 162, 235, 0.8)',
            borderColor:
                'rgba(54, 162, 235, 1)',
            borderWidth: 1
        },
        {
            label: 'Payments',
            data: {{ payments_chart_data }},
            yAxisID: 'y-axis-2',
            backgroundColor:
                'rgba(235, 162, 54, 0.8)',
            borderColor:
                'rgba(235, 162, 54, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 0
        },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                },
                display: true,
                position: 'left',
                id: 'y-axis-1',
            },
            {
                ticks: {
                    beginAtZero:true,
                    // Include a dollar sign in the ticks
                    callback: function(value, index, values) {
                        return '$' + value.toFixed(0);
                    }
                },
                display: true,
                position: 'right',
                id: 'y-axis-2',
                gridLines: {
                    drawOnChartArea: false
                }
            }
            ]
        }
    }
});
</script>
{% endblock %}

{% block content %}
<div class="container">
    <h3>Pittsburgh Parking Reports</h3>
    <h5>Lots and Metered Parking</h5>
    <br>
    <div class="row" style="column-rule-style: dashed;">
         <div class="twelve columns">
             <form method="post">
                {% csrf_token %}

                {{ form.non_field_errors }}
                <div class="fieldWrapper">
                    <div class = "six columns">
                        <span>
                            {{ form.zone.errors }}
                            <b>Zone:</b>
                            {{ form.zone }}
                        </span>
                    </div>
                    <div class = "six columns">
                        <div id="tabs">
                          <ul>
                            <li><a href="#month-tab" id="month-picker-link">Month picker</a></li>
                            <li><a href="#date-tab" id="date-picker-link">Date-range picker</a></li>
                          </ul>
                          <div id="month-tab">
                              <p><span>
                                    {{ form.year.errors }}
                                    <b>Year:</b>
                                    {{ form.year }}
                                </span>
                                &nbsp;
                                <span>
                                    {{ form.month.errors }}
                                    <b>Month:</b>
                                    {{ form.month }}
                                </span>
                              </p>
                          </div>
                          <div id="date-tab">
                            <div>
                                <b>From:</b>
                                <input type="text" id="fromdatepicker">
                            </div>
                            <div>
                                <b>To:</b>
                                <input type="text" id="todatepicker">
                            </div>
                          </div>
                        </div>

                    </div>
                </div>

            </form>
        </div>
    </div>
    <P>
    <div id="results">
        <div class="row">
            <div class="twelve columns">
                <div id="output">
                    {% autoescape off %}
                    {{ output_table }}
                    {% endautoescape %}
                </div>
                <button onclick="copyTable()">Copy table</button>
                <button onclick="download('aggregated_results.csv',)">Download CSV</button>
            </div>
        </div>
        <div class ="row">
            <div class="twelve columns">
                <div id="chart_a">
                    <canvas id="myChart" width="400" height="100"></canvas>
                </div>
            </div>
        </div>
        <P></P>
        <div class="row">
            <div class="six columns">
                <h5>Zone/lot features for selected lot</h5>
                <b>Selected lot:</b> <span id="output_zone">{{ display_zone }}</span><br>
                <b>Rate:</b> $<span id="rate">{{ zone_features.rate }}</span>/hour, <b>Space count:</b> <span id="spaces">{{ zone_features.spaces }}</span>, <b>Lease count:</b> <span id="leases">{{ zone_features.leases }}</span>
            </div>
            <div class="six columns">
                <h5>Date range for selected time range</h5>
                <b>Selected range:</b> <span id="selected_time_range">{{ display_time_range }}</span><br>
                <b>Start datetime:</b> <span id="start_dt">{{ start_dt }}</span><br>
                <b>End datetime:</b> <span id="end_dt">{{ end_dt }}</span>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
<script>

    var frompicker = new Pikaday({
        field: document.getElementById('fromdatepicker'),
        format: 'YYYY-MM-DD',
        toString(date, format) {
            // you should do formatting based on the passed format,
            // but we will just return 'D/M/YYYY' for simplicity
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            var mm   = ((month > 9) ? '' : '0') + month;
            var dd   = ((day > 9)   ? '' : '0') + day;

            return `${year}-${mm}-${dd}`;
        },
        onSelect: function() {
            refresh_dates();
            refresh_features();
            regenerate_output();
            topicker.setMinDate(new Date(this.getDate().getTime()+parseInt(0*24*60*60*1000)));
            if(Number(new Date(this.getDate()))>Number(new Date(document.getElementById('todatepicker').value)))
            {
                document.getElementById('todatepicker').value="";
            }
        },
        parse(dateString, format) {
            // dateString is the result of `toString` method
            const parts = dateString.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }
    });


    var topicker = new Pikaday({
        field: document.getElementById('todatepicker'),
        format: 'YYYY-MM-DD',
        toString(date, format) {
            // you should do formatting based on the passed format,
            // but we will just return 'D/M/YYYY' for simplicity
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            var mm   = ((month > 9) ? '' : '0') + month;
            var dd   = ((day > 9)   ? '' : '0') + day;

            return `${year}-${mm}-${dd}`;
        },
        onSelect: function() {
            frompicker.setMaxDate(new Date(this.getDate().getTime()+parseInt(0*24*60*60*1000)));
            if(Number(new Date(this.getDate()))<Number(new Date(document.getElementById('fromdatepicker').value)))
            {
                document.getElementById('fromdatepicker').value="";
            }
            refresh_dates();
            refresh_features();
            regenerate_output();
        },
        parse(dateString, format) {
            // dateString is the result of `toString` method
            const parts = dateString.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }
    });

    const copyToClipboard = str => {
      const el = document.createElement('textarea');
      el.value = str;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
    };

    function reformatTable(useCommas) {
        var t = document.getElementById("results_table");
        var trs = t.getElementsByTagName("tr");
        var importable = "";

        for (var i=0; i<trs.length; i++)
        {
            tds = trs[i].getElementsByTagName("td");
            if (tds.length === 0) {
                ths = trs[i].getElementsByTagName("th");
                tds = ths;
            }
            for (var n=0; n<tds.length;n++)
            {
                if (useCommas) {
                    importable += '"';
                }
                importable += tds[n].textContent;
                if (useCommas) {
                    importable = importable.slice(0, -1);
                    importable += '",';
                }
            }
            importable = importable.slice(0, -1);
            if (i < trs.length - 1) {
                importable += "\n";
            }
        }
        return importable;
    }

    function copyTable() {
        importable = reformatTable(false);
        copyToClipboard(importable);
        alert("Copied the text: " + importable);
    }

    function download(filename) {
        text = reformatTable(true);
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }
</script>
{% endblock content %}
{% block footer %}
{% endblock footer %}
